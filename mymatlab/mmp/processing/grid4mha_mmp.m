function grid4_mmpMHA(startdrop,stopdrop)%% GRID4_MMP  Grid MMP data of a specified drop range into 1 m bins% and place into pre-existing gridded files for each variable.  %		startdrop=drop to start with%		stopdrop=last drop to grid%% modified from grid2_mmp 22/10/98 by j. mackinnon%%Well I discovered that Jen's routine did not sort density prior%to computing N2.  So I saved the results of the first run in%gridded_nosort and am rerunning, using a function that I modified%from Mike's nsqfcn.  nsqfcn_sortrho does the sorting of the density%first.  Then the results are saved in gridded.%%12/8/99%I modified this routine to create appropriate grids for aug99.%No pre-gridded files are necessary.startdrop=7646;stopdrop=7664;mmpfolderscruise=read_cruises_mmp(startdrop);% load mmplogfstr1=[procdata FSP cruise FSP ];eval(['load ' fstr1 'mmplog.mat']);dpr=.01;prmax=2; %200 m% find drops we want from the timeplace matrixin = find(mmplog(:,1)>=startdrop & mmplog(:,1)<=stopdrop);yday=mmplog(:,3);drops=mmplog(:,1);pr=(.01:dpr:prmax);mmp=mmplog(:,11);dp=mean(diff(pr));ndrops=length(in);Sal=zeros(length(pr),length(drops));Sigmat=Sal;Theta=Sal;Eps=Sal;Obs=Sal;N2=Sal;% start loading data.  for i=1:ndrops;  	drop=drops(in(i))	DisplayProgress(drop,20);  	% start with thetasd quantities  	[p,t,th,s,sgth]=get_thetasd2_mmp(drop,'t','th','s','sgth',0);   good = find(~isnan(p)); 	if length(good)>0    Theta(:,in(i))=regrid(th(good),p(good),pr)';    Sal(:,in(i))=regrid(s(good),p(good),pr)';    Sigmat(:,in(i))=regrid(sgth(good),p(good),pr)'; 	end;	   % do nsq   [ps,isort]=sort(p);   ig=find(~isnan(s(isort))&~isnan(t(isort))&~isnan(p(isort)));   [n2,pn,dthetadz,dsdz]=nsqfcn_sortrho(s(isort(ig)),t(isort(ig)),p(isort(ig)),pr(1)-dp/2,dp);%  [n2,pn,dthetadz,dsdz]=nsqfcn(s(isort(ig)),t(isort(ig)),p(isort(ig)),pr(1)-dp/2,dp);   % find appropriate place to stick nsq value    N2(:,in(i))=interp1(pn,n2,pr)';              % load epsilon, using simple bin averages to regrid   [epsilon, p]=get_epsilon1_mmp(drop);    good = find(~isnan(p));	if length(good)>0      Eps(:,in(i))=regrid2(epsilon(good),p(good),pr,.01)';   end;   	% load obs data  	[obsin,p]=get_obs_mmp(drop);   good = find(~isnan(p));	if length(good)>0    Obs(:,in(i))=regrid(obsin(good),p(good),pr)';  	end;end;%Now truncate -- no need to save 1000 drops.yday=yday(in);drops=drops(in);Eps=Eps(:,in);Sal=Sal(:,in);Theta=Theta(:,in);Obs=Obs(:,in);N2=N2(:,in);Sigmat=Sigmat(:,in);disp('All done :) saving final results...')eval(['save ' fstr1 'gridded' FSP 'Sal Sal yday drops pr'])eval(['save ' fstr1 'gridded' FSP 'Sigmat Sigmat yday drops pr'])eval(['save ' fstr1 'gridded' FSP 'Theta Theta yday drops pr'])eval(['save ' fstr1 'gridded' FSP 'Eps Eps yday drops pr'])eval(['save ' fstr1 'gridded' FSP 'N2 N2 yday drops pr'])eval(['save ' fstr1 'gridded' FSP 'Obs Obs yday drops pr'])